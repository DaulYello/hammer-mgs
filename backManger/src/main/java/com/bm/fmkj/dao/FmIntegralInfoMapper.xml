<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bm.fmkj.dao.FmIntegralInfoMapper">
  <resultMap id="BaseResultMap" type="com.bm.fmkj.dao.FmIntegralInfo">
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="uid" jdbcType="INTEGER" property="uid" />
    <result column="integral_num" jdbcType="DOUBLE" property="integralNum" />
  </resultMap>


  <insert id ="allotRToUser" parameterType="java.util.List">
      insert into fm_integral_info
          (uid, integral_num, create_date)
          values
           <foreach collection ="list" item="integralInfo" index= "index" separator =",">
               (
               #{integralInfo.uid},
               #{integralInfo.integralNum},
               #{integralInfo.createDate}
               )
           </foreach >
  </insert>

    <select id="queryRBefore" resultMap="BaseResultMap">

        SELECT
          uid,
          SUM(integral_num) AS integral_num
        FROM
          fm_integral_info
        WHERE create_date BETWEEN
          (SELECT
            DATE_SUB(NOW(), INTERVAL 120 HOUR))
          AND
          (SELECT
            DATE_SUB(NOW(), INTERVAL 48 HOUR))
          AND STATUS = 0
        GROUP BY uid

    </select>

    <select id="queryLastInvitRank" resultType="java.util.HashMap">
        SELECT
          uid,
          COUNT(uid) AS invitingNum
        FROM
          hc_points_record
        WHERE TIME BETWEEN
          (SELECT
            DATE_FORMAT(
              DATE_SUB(
                DATE_SUB(
                  CURDATE(),
                  INTERVAL WEEKDAY(CURDATE()) DAY
                ),
                INTERVAL 1 WEEK
              ),
              '%Y-%m-%d 00:00:00'
            ))
          AND
          (SELECT
            DATE_FORMAT(
              SUBDATE(CURDATE(), WEEKDAY(CURDATE()) + 1),
              '%Y-%m-%d 23:59:59'
            ))
        GROUP BY uid
        ORDER BY invitingNum DESC
        LIMIT 0, 3
    </select>
</mapper>